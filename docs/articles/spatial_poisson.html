<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Poisson Process • pldensity</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial Poisson Process">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pldensity</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dynamic_data.html">Fit dynamic distributions</a>
    </li>
    <li>
      <a href="../articles/intro.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/rideaustin.html">Ride Austin</a>
    </li>
    <li>
      <a href="../articles/spatial_poisson.html">Spatial Poisson Process</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Spatial Poisson Process</h1>
                        <h4 class="author">Mauricio Tec &amp; Natalia Zuniga</h4>
            
            <h4 class="date">2018-05-09</h4>
      
      
      <div class="hidden name"><code>spatial_poisson.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(pldensity)
<span class="kw">library</span>(ggplot2)

<span class="kw">set.seed</span>(<span class="dv">110104</span>)</code></pre></div>
<div id="first-order-dlm-applied-to-count-data" class="section level1">
<h1 class="hasAnchor">
<a href="#first-order-dlm-applied-to-count-data" class="anchor"></a>First-order DLM applied to count data</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(austin)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">by_min &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># minutes</span>

tmin &lt;-<span class="st"> </span><span class="kw">min</span>(austin<span class="op">$</span>started_on)
tmax &lt;-<span class="st"> </span><span class="kw">max</span>(austin<span class="op">$</span>started_on)
time_vec &lt;-<span class="st"> </span><span class="kw">seq</span>(tmin, tmax, <span class="dt">by =</span> by_min <span class="op">*</span><span class="st"> </span><span class="dv">60</span>)
periods &lt;-<span class="st"> </span><span class="kw">length</span>(time_vec[]) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>

counts &lt;-<span class="st"> </span><span class="kw">numeric</span>(periods)
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>periods) {
  counts[i] &lt;-<span class="st"> </span><span class="kw">sum</span>(time_vec[i] <span class="op">&lt;</span><span class="st"> </span>austin<span class="op">$</span>started_on <span class="op">&amp;</span><span class="st"> </span>austin<span class="op">$</span>started_on <span class="op">&lt;</span><span class="st"> </span>time_vec[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]) 
}

count_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">tmin =</span> time_vec[<span class="op">-</span><span class="kw">length</span>(time_vec)], <span class="dt">tmax =</span> time_vec[<span class="op">-</span><span class="dv">1</span>], <span class="dt">count =</span> counts)
count_data</code></pre></div>
<pre><code>##                   tmin                tmax count
## 1  2017-04-13 20:30:04 2017-04-13 20:31:04     7
## 2  2017-04-13 20:31:04 2017-04-13 20:32:04     3
## 3  2017-04-13 20:32:04 2017-04-13 20:33:04     9
## 4  2017-04-13 20:33:04 2017-04-13 20:34:04     5
## 5  2017-04-13 20:34:04 2017-04-13 20:35:04     5
## 6  2017-04-13 20:35:04 2017-04-13 20:36:04     4
## 7  2017-04-13 20:36:04 2017-04-13 20:37:04     9
## 8  2017-04-13 20:37:04 2017-04-13 20:38:04     3
## 9  2017-04-13 20:38:04 2017-04-13 20:39:04     5
## 10 2017-04-13 20:39:04 2017-04-13 20:40:04     6
## 11 2017-04-13 20:40:04 2017-04-13 20:41:04     3
## 12 2017-04-13 20:41:04 2017-04-13 20:42:04     8
## 13 2017-04-13 20:42:04 2017-04-13 20:43:04     5
## 14 2017-04-13 20:43:04 2017-04-13 20:44:04     5
## 15 2017-04-13 20:44:04 2017-04-13 20:45:04     9
## 16 2017-04-13 20:45:04 2017-04-13 20:46:04     7
## 17 2017-04-13 20:46:04 2017-04-13 20:47:04     3
## 18 2017-04-13 20:47:04 2017-04-13 20:48:04     5
## 19 2017-04-13 20:48:04 2017-04-13 20:49:04     5
## 20 2017-04-13 20:49:04 2017-04-13 20:50:04     5
## 21 2017-04-13 20:50:04 2017-04-13 20:51:04     5
## 22 2017-04-13 20:51:04 2017-04-13 20:52:04     3
## 23 2017-04-13 20:52:04 2017-04-13 20:53:04    12
## 24 2017-04-13 20:53:04 2017-04-13 20:54:04     3
## 25 2017-04-13 20:54:04 2017-04-13 20:55:04     8
## 26 2017-04-13 20:55:04 2017-04-13 20:56:04     3
## 27 2017-04-13 20:56:04 2017-04-13 20:57:04     6
## 28 2017-04-13 20:57:04 2017-04-13 20:58:04     3
## 29 2017-04-13 20:58:04 2017-04-13 20:59:04     5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(count_data<span class="op">$</span>tmin, count_data<span class="op">$</span>count, <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">main =</span> <span class="st">"counts"</span>,<span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw">points</span>(count_data<span class="op">$</span>tmin, count_data<span class="op">$</span>count, <span class="dt">pch =</span> <span class="dv">21</span>, <span class="dt">bg =</span> <span class="st">"orange"</span>)</code></pre></div>
<p><img src="spatial_poisson_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>Very simple model <span class="math display">\[
\begin{aligned}
\text{Observation equation: } \quad &amp; \eta_t \sim \mathrm{Poisson}(\Lambda_t) \\
\text{Structural equation: } \quad &amp;\log \Lambda_t  = \eta_t + v_t, &amp; v_t \sim N(0, V), V\sim\mathrm{InvGam}(\nu_0/2,\xi_0/2) \\
\text{State equation: }\quad  &amp; \eta_t  = \eta_{t - 1} + w_t,&amp; w_t \sim N(0, W_t)
\end{aligned}
\]</span> and we’ll use a discount factor <span class="math inline">\(\delta \in (0,1]\)</span> is a discount factor such that <span class="math inline">\(W_t = \mathrm{Var}(\eta_t \mid \Lambda^t) / \delta\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prior &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">nu0 =</span> <span class="dv">1</span>, <span class="dt">xi0 =</span> <span class="dv">5</span>)</code></pre></div>
<p>We start with the Kalman filtering moments <span class="math display">\[
p(\eta_t \mid \Lambda^t) = N(\eta_t \mid m_t, C_t)
\]</span> <span class="math display">\[
p(\log(\Lambda_t) \mid m_{t-1}, C_{t-1}, V) = N(\log(\Lambda_t) \mid f_t, Q_t)
\]</span> We sample <span class="math inline">\(\log\Lambda_t\)</span> from these distribution. The recursions give <span class="math inline">\(m_{t-1}, c_{t-1}\)</span> go as follows. First, <span class="math display">\[
p(\eta_t \mid n^{t-1}) = N(\eta_t \mid m_{t-1}, R_t), \quad R_t = C_{t-1}/\delta.
\]</span> So the forecast moments are <span class="math inline">\(f_t=m_{t-1}\)</span> and <span class="math inline">\(Q_t = R_t + V\)</span>. Then parameter updates are <span class="math display">\[
m_t = m_{t-1} + \frac{R_t}{Q_t}(\log\Lambda_t - f_t) \quad \text{ and } \quad C_t = R_t \frac{V}{Q_t}.
\]</span> Finally, and offline draw from <span class="math inline">\(V\)</span> is taken from <span class="math inline">\(\mathrm{InvGam}(\nu_t/2, \xi_t/2)\)</span> where <span class="math inline">\(\nu_t = \nu_{t-1} + 1\)</span> and <span class="math inline">\(\xi_t = \xi_{t-1} + (\log\Lambda_t - \eta_t)^2\)</span>.</p>
<p>All that rests is how to do the sampling for <span class="math inline">\(\log\Lambda_t\)</span>. We have that (omitting extra parameters/hyperparameters from the notation for simplicity) <span class="math display">\[
p(m_t, C_t, \eta_t \mid n^t) \propto \int  p(m_t, C_t \mid \Lambda_{t-1}, m_{t-1}, C_{t-1}) p(\Lambda_t, n_t \mid m_{t-1},C_{t-1}) d\Lambda_t dP(m_{t-1}, C_{t-1} \mid n^{t-1}).
\]</span> Here the joint is <span class="math display">\[
p(\Lambda_t, n_t \mid m_{t-1}, C_{t-1}, V) = \mathrm{Poisson}(n_t \mid \Lambda_t)N(\log(\Lambda_t) \mid f_t, Q_t).
\]</span> But we don’t want to blindly use the forecasting moments for sampling <span class="math inline">\(\Lambda\)</span>, because that usually leads to too diffuse proposals. Instead we’ll base in the approximation to Poisson likelihood $(n_t_t) N(_t (n_t), 1 / n_t)/n_t $, so that <span class="math inline">\(\log\Lambda_t \approx \log n_t + \epsilon_t\)</span> and <span class="math inline">\(\epsilon_t \sim N(1, 1/ n_t)\)</span>. Together, they give the sampling startegy:</p>
<p><em>Resampling from <span class="math inline">\(\log\Lambda_t\)</span></em>: Simulate particles by setting <span class="math inline">\(\epsilon_t^{(i)} \sim N(0, 1/n_t)\)</span> and <span class="math inline">\(\Lambda^{(i)} = n_t + \epsilon_t^{(i)}\)</span>. Resample the particles from the distribution with importance sampling weights proportional to <span class="math inline">\(\mathrm{Poisson}(n_t\mid \Lambda^{(i)})(n_t \mid \Lambda_t)N(\log(\Lambda_t) \mid f_t, Q_t) / N(\log\Lambda_t \mid \log(n_t), 1 / n_t)\)</span>.</p>
<div id="implementation" class="section level3">
<h3 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nparticles =<span class="st"> </span><span class="dv">100</span>
delta =<span class="st"> </span><span class="fl">0.99</span>

m0 =<span class="st"> </span><span class="dv">2</span>
C0 =<span class="st"> </span><span class="fl">0.1</span>
nu0 =<span class="st"> </span><span class="dv">2</span>
xi0 =<span class="st"> </span><span class="fl">0.1</span>

res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/firstorder_poisson_dlm.html">firstorder_poisson_dlm</a></span>(counts, m0, C0, nu0, xi0, delta, nparticles)
logintensity &lt;-<span class="st"> </span>res<span class="op">$</span>logintensity
mean &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">exp</span>(logintensity), <span class="dv">1</span>, mean)
sd &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">exp</span>(logintensity), <span class="dv">1</span>, sd)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pltdata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">period =</span> count_data<span class="op">$</span>tmin, <span class="dt">obs =</span> counts, <span class="dt">mean =</span> mean, <span class="dt">sd =</span> sd)
<span class="kw">ggplot</span>(pltdata, <span class="kw">aes</span>(<span class="dt">x =</span> period)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean), <span class="dt">col =</span> <span class="st">"blue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> obs), <span class="dt">col =</span> <span class="st">"orange"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> mean <span class="op">-</span><span class="st"> </span>sd, <span class="dt">ymax =</span> mean <span class="op">+</span><span class="st"> </span>sd), <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Intensity filtering Poisson DLM example"</span>, 
       <span class="dt">subtitle =</span> <span class="st">"Showing one std. dev. intervals"</span>,
       <span class="dt">ylab =</span> <span class="st">"intensity"</span>)</code></pre></div>
<p><img src="spatial_poisson_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
</div>
<div id="model-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#model-selection" class="anchor"></a>Model selection</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nu0_list &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">20</span>, <span class="dv">5</span>)
delta_list &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.19</span>, <span class="fl">0.99</span>, <span class="fl">0.5</span>)
xi0_list &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">10</span>, <span class="fl">0.5</span>)

params &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">nu0 =</span> nu0_list, <span class="dt">delta =</span> delta_list, <span class="dt">xi0 =</span> xi0_list)
params<span class="op">$</span>logmarginal &lt;-<span class="st"> </span><span class="dv">0</span>
results &lt;-<span class="st"> </span><span class="kw">list</span>()
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(params)) {
  results[[i]] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/firstorder_poisson_dlm.html">firstorder_poisson_dlm</a></span>(counts, m0, C0, params<span class="op">$</span>nu0[i], params<span class="op">$</span>xi0[i], params<span class="op">$</span>delta[i], nparticles)
  params<span class="op">$</span>logmarginal[i] &lt;-<span class="st"> </span>results[[i]]<span class="op">$</span>logmarginal
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">best &lt;-<span class="st"> </span><span class="kw">which.max</span>(params<span class="op">$</span>logmarginal)
params <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(logmarginal)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>)</code></pre></div>
<pre><code>##   nu0 delta       xi0 logmarginal
## 1  16  0.69 3.1622777   -58.67165
## 2   6  0.69 0.3162278   -58.76330
## 3   1  0.69 0.3162278   -58.86815
## 4  11  0.69 3.1622777   -58.89934
## 5  11  0.69 1.0000000   -58.91973</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logintensity &lt;-<span class="st"> </span>results[[best]]<span class="op">$</span>logintensity
mean &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">exp</span>(logintensity), <span class="dv">1</span>, mean)
sd &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">exp</span>(logintensity), <span class="dv">1</span>, sd)
pltdata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">period =</span> count_data<span class="op">$</span>tmin, <span class="dt">obs =</span> counts, <span class="dt">mean =</span> mean, <span class="dt">sd =</span> sd)
<span class="kw">ggplot</span>(pltdata, <span class="kw">aes</span>(<span class="dt">x =</span> period)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> mean), <span class="dt">col =</span> <span class="st">"blue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> obs), <span class="dt">col =</span> <span class="st">"orange"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> mean <span class="op">-</span><span class="st"> </span>sd, <span class="dt">ymax =</span> mean <span class="op">+</span><span class="st"> </span>sd), <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Intensity filtering Poisson DLM best model"</span>, 
       <span class="dt">subtitle =</span> <span class="st">"Showing one std. dev. intervals"</span>,
       <span class="dt">ylab =</span> <span class="st">"intensity"</span>)</code></pre></div>
<p><img src="spatial_poisson_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#first-order-dlm-applied-to-count-data">First-order DLM applied to count data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#model-selection">Model selection</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by .</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
